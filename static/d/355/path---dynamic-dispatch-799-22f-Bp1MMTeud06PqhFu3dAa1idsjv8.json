{"data":{"markdownRemark":{"htmlAst":{"type":"root","children":[{"type":"element","tagName":"h2","properties":{},"children":[{"type":"text","value":"What is dynamic dispatch?"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"hr","properties":{},"children":[]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Dispatch is how the compiler knows which routine to execute at compilation time. However, sometimes the compiler won't know at compilation which routine to execute. In this case, virtual functions are needed. A virtual function is a member function of the base class that is overridden by a derived class."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h2","properties":{},"children":[{"type":"text","value":"How does it work?"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"hr","properties":{},"children":[]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"To start, we'll begin with a simple base class, \"Vehicle\":"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"c++"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-c++"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-c++"]},"children":[{"type":"text","value":"    #include <iostream>\n    using namespace std;\n    class Vehicle\n    {\n    public:\n    virtual void loadCapacity();\n    virtual void applyBrakes();\n    virtual void fuelUp();\n    };\n    void Vehicle::loadCapacity() {\n    cout << “Vehicle is loaded to capacity.” << endl;}\n\n    void Vehicle::applyBrakes() {\n    cout << “Vehicle is braking.” << endl;}\n\n    void Vehicle::fuelUp() {\n    cout << “Vehicle is fueling up.” << endl;}"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"This base class implements 3 virtual functions, which can then be overridden by subclasses of Vehicle:"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"text"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-text"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"class Car : public Vehicle\n{\npublic:\n\tvoid applyBrakes();\n\tvoid fuelUp();\n};\n\nvoid Car::applyBrakes() {\ncout << “Car is braking.” << endl;}\n\nvoid Car::fuelUp() {\ncout << “Car is fueling up with gas.” << endl;}"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Now the subclass Car, which inherits from Vehicle, has its own implementation of the virtual methods (except for "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"loadCapacity()"}]},{"type":"text","value":"). Now say at run-time in the main method, this line is called:"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"text"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-text"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"Vehicle *v = new Car();\nv->fuelUp();"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"with output:"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"text"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-text"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"Car is fueling up with gas."}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"How are the function calls resolved for our object v? How does it know to call cars fuelUp() function correctly rather than vehicle's?"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h2","properties":{},"children":[{"type":"text","value":"Virtual Tables"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"hr","properties":{},"children":[]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"For both Vehicle and Car classes, a virtual table at the assembly level is created that contains pointers to each definition of the virtual methods, whether it be inherited from a base class or declared within the class. Here are the vtables for our two classes below:"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"-"},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"compiled with x86 gcc assembly"}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"text"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-text"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"vtable for Vehicle:\n  .quad 0\n  .quad typeinfo for Vehicle\n  .quad Vehicle::loadCapacity()\n  .quad Vehicle::applyBrakes()\n  .quad Vehicle::fuelUp()\n\nvtable for Car:\n  .quad 0\n  .quad typeinfo for Car\n  .quad Vehicle::loadCapacity()\n  .quad Car::applyBrakes()\n  .quad Car::fuelUp()"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"You can see that because Car doesn't declare a "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"loadCapacity()"}]},{"type":"text","value":" in its own class, it's vtable contains a pointer to Vehicle's declaration of "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"loadCapacity()"}]},{"type":"text","value":". You can see that in addition to the function declarations, .quad 0 is created which makes space for the v-pointer to the table, and also typeinfo is created for each class ( which ends up equating to \"7Vehicle\" and \"3Car\" for each as unique identifiers)."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"When "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"Vehicle *v = new Car();"}]},{"type":"text","value":" is called,"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ol","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Vehicle's constructor is called"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"The virtual table for Vehicle is created (quad directives above)"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"v is set to point to the v-pointer of the Vehicle virtual table ("},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"v->_vptr.Vehicle;"}]},{"type":"text","value":")"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Student's constructor is called, updating the object"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Virtual table for Car is created"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"The vpointer is updated ("},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"v->_vptr.Car)"}]}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Here is the assembly for "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"Vehicle *v = new Car();"}]},{"type":"text","value":" where you can see these calls"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"text"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-text"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"\tmov edi, 8\n  call operator new(unsigned long)\n  mov rbx, rax\n  mov QWORD PTR [rbx], 0\n  mov rdi, rbx\n  call Car::Car() [complete object constructor]\n  mov QWORD PTR [rbp-24], rbx"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"And here is the Car constructor which shows the creation of the vtable and an internal Vehicle construction call:"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"text"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-text"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"Car::Car() [base object constructor]:\n  push rbp\n  mov rbp, rsp\n  sub rsp, 16\n  mov QWORD PTR [rbp-8], rdi\n  mov rax, QWORD PTR [rbp-8]\n  mov rdi, rax\n  call Vehicle::Vehicle() [base object constructor]\n  mov edx, OFFSET FLAT:vtable for Car+16\n  mov rax, QWORD PTR [rbp-8]\n  mov QWORD PTR [rax], rdx\n  nop\n  leave\n  ret"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Thus, when "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"v->fuelUp();"}]},{"type":"text","value":" is called, v points to the v-pointer of the car virtual table (a memory address), a number is added to that address to access the function pointer (16 bytes below as each function pointer is 8 bytes and fuelUp is car's second function declaration), which then is followed to call Car's fuelUp() routine (by calling the address in rax below)."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"v->fuelUp();"}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"text"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-text"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"\tmov rax, QWORD PTR [rbp-24]\n  mov rax, QWORD PTR [rax]\n  add rax, 16\n  mov rax, QWORD PTR [rax]\n  mov rdx, QWORD PTR [rbp-24]\n  mov rdi, rdx\n  call rax"}]}]}]}],"data":{"quirksMode":false}},"frontmatter":{"date":"November 04, 2018","path":"/dynamic-dispatch","subtitle":"","title":"How dynamic dispatch works at the assembly level","cover":{"childImageSharp":{"fluid":{"base64":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsSAAALEgHS3X78AAADHUlEQVQ4y21TW0jTURzeS/TYY0j1EIlQZEWJ9RAVRQQh9FAgkmX5oGGFl7QbWaHdRXpQSTGUTOelNExt6NRN523O29x07r656XRzbi7n7n6dc8ZQoQ8O//M////5znd+3/fjgGBzc5MNCsfqKtQqFbxeL/6H1pZmfHhTgMovZagoKyWjBL38LpR8LkYXjwdOhCgCtVIJvU6HFZsNNqsVq3Y71pxOOByr7Hvq7WTs2b0LcUeP4GDUXiRcvoS2pnqcPByDZ3m54NCfXC7XDkVOh4ORWpeXodWoYdTrmXKKxznZOLQ/CrEx0Yg+sA8pSYmQiodx5ngsCl+9BIcS8drbMDEmgZMooar0Oi17Hx4YgHhoCCqienlpKUyYnclIGrm1EPTwMTIoglomRXpyEp4/yQNHrZzDYH8/pqcmGZnf74fb7UYwECCqPYzE4/EgEPAjFArhe3UV7DYrW99wrUE+OoLa8lKkJl5HSXHRVg3p9ZQKBRbNZhjIdXUaDRQzM4wkgiCZN9bWoL/zD0RkdDRxUVH0HvlZD3Ax/hSK3hZuEfrI1YPBIFPi2dgIqyTv2wkpOtt/o6+Th7npKYj7BGipq0E1cfxTwWv093TvdJmaQYkioKqXlyxhl4kp2w8PhYKYNxiwYDLR4CHg99H8gRNRMCuXQSQUEiNEcK2tsTWRQIDmxgYsLpiZ09QYi8kIbmU5uF8rUE/Gj29VbF768R34He1bhHTDhEQCnVZDTvOzNWrS2KgY80YjtGoVfD4f5BNj+FlTjfxHWXj6MAMvcjKRm5GOu4k38KupIZzDCGiYI6Aq3evr+EsyGmCOe1k9B3q7ISXO3k+9g9MnjiHxWgKuXryANBIbehjL4YxsmsXFsrjANm4QU2TSKUxPTrIS0G6x21dYDaWSUUgG+pB26yaunD/LCM/Fx+FeSjJk44SQRoXWSa/VMsIliwVm0zwMpAQalRKqOQULfMQQvWoO8vFRiLo7MSLsQWtDHashzaKQuM+uvGA2MVNo/miXzMrlsK+ssCc9aHt0bJZFRmpQK2Ei9R4i0eF3kE4jHTNDmuMfhjO00MmPPUEAAAAASUVORK5CYII=","aspectRatio":1.4216867469879517,"src":"/static/be2743af621db830b607d8a6a2259773/97318/Untitled-ef2295d2-ec31-49f1-8c4d-27e1210c522f.png","srcSet":"/static/be2743af621db830b607d8a6a2259773/1f258/Untitled-ef2295d2-ec31-49f1-8c4d-27e1210c522f.png 175w,\n/static/be2743af621db830b607d8a6a2259773/4cb21/Untitled-ef2295d2-ec31-49f1-8c4d-27e1210c522f.png 350w,\n/static/be2743af621db830b607d8a6a2259773/97318/Untitled-ef2295d2-ec31-49f1-8c4d-27e1210c522f.png 700w,\n/static/be2743af621db830b607d8a6a2259773/43a3b/Untitled-ef2295d2-ec31-49f1-8c4d-27e1210c522f.png 708w","sizes":"(max-width: 700px) 100vw, 700px"}}}}}},"pageContext":{}}